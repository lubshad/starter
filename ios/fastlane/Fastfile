

ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "gbsq-iaxx-vwna-kdfa"

default_platform(:ios)

platform :ios do
  # ----------------------------
  # Lane 1: Upload IPA to TestFlight
  # ----------------------------
  desc "Upload existing IPA to TestFlight"
  lane :upload_testflight do
    upload_to_testflight(
      ipa: "../build/ios/ipa/staffhour.ipa",
      skip_waiting_for_build_processing: false,  # wait until Apple finishes processing
      distribute_external: false,
      changelog: "Bug Fixing And Improvements"
    )
    UI.success("✅ IPA uploaded to TestFlight!")
  end

  # ----------------------------
  # Lane 2: Upload to both TestFlight and App Store
  # ----------------------------
  desc "Upload IPA to TestFlight and App Store (creates new version)"
  lane :submit_for_review do
    # First upload to TestFlight
    upload_testflight
    
    # Then upload to App Store (creates new version if needed)
    deliver(
      submit_for_review: true,
      automatic_release: true,  # set true to release immediately after approval
      force: true,
      skip_metadata: true,
      skip_screenshots: true,
      skip_binary_upload: true,  # uses latest processed build from TestFlight
      precheck_include_in_app_purchases: false
    )
    UI.success("✅ Build submitted for App Store review!")
  end

  # ----------------------------
  # Lane 3: Combined lane
  # ----------------------------
  desc "Upload IPA to TestFlight and submit to App Store review"
  lane :release_app do
    upload_testflight
    submit_appstore
    UI.success("✅ Build uploaded to TestFlight and submitted for App Store review!")
  end
end
